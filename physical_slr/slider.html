
	<!DOCTYPE html>
	<html lang='en'>
	<meta charset="utf-8">
	<head>
	<title>Physical Vulnerability: Sea Level Rise in Vancouver, B.C.</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Mapping Packages -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
	<!-- jQuery is a library that simplifies many things in JavaScript. Used to retrieve data from the web. -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

	<!-- External JavaScript Packages -->
	<script src="https://mychellew.github.io/mychellew-web/Leaflet.TileLayer.GL.js"></script>
	<script src="https://mychellew.github.io/mychellew-web/leaflet-slider.js"></script>

	<!-- External CSS Packages -->
		<link rel="stylesheet" href="https://mychellew.github.io/mychellew-web/leaflet-slider.css"/>

 <style>
 .legend {
    line-height: 18px;
    color: #555;
}
.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}
 </style>
	</head>
	<body>

	<div id="map" style='width:100%; max-height:100%; height:700px;'></div>
	<div>Sea Level Rise (m): <input id='add-slr' type='range' min=0 max=6 step=1 style='width: 20em'/></div>

	<script type="text/javascript">
	// This script to differentiate the various RGB values from the original Mapbox Terrain-RGB
	// has been sourced from the following GitHub
	// As per request for using this code:
	//"THE BEER-WARE LICENSE":
	//<ivan@sanchezortega.es> wrote this file. As long as you retain this notice you
	//can do whatever you want with this stuff. If we meet some day, and you think
	//this stuff is worth it, you can buy me a beer in return.
	var fragmentShader =
	`
	void main(void) {
		highp vec4 texelColour = texture2D(uTexture0, vec2(vTextureCoords.s, vTextureCoords.t));
		// Height is represented in TENTHS of a meter
		highp float height = (
			texelColour.r * 255.0 * 256.0 * 256.0 +
			texelColour.g * 255.0 * 256.0 +
			texelColour.b * 255.0 )
		-100000.0;
		if (height > slrValue) {
			// Height > sea level, transparent
			gl_FragColor = vec4(0.5, 0.5, 0.5, 1.0);
		} else {
			// Water, some semiopaque blue
			gl_FragColor = vec4(0.05, 0.1, 0.9, 1.0);
		}
	}
	`
	var tileSize = 256;
	//Set the Map to Vancouver
	var map = L.map('map', {
		center: [49.2827, -123.1207],
		zoom: 11
	});
	// Access to the Basemaps
	var mapboxAccessToken = 'pk.eyJ1IjoibXljaGUxMWV3IiwiYSI6ImNqcnNkN3hocDFvazk0M3JvdWtya2YyYXkifQ.YaXS3C0R0dBAkDinTx1z8w';
	//Create the Base Layer
	var base = L.tileLayer("https://{s}.tiles.mapbox.com/v4/mapbox.outdoors/{z}/{x}/{y}.png?access_token=" + mapboxAccessToken, {
		attribution: 'Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy;<a href="https://www.mapbox.com/map-feedback/">Mapbox</a>'
	}).addTo(map);
	// Call Mapbox's Terrain-RGB map layer and add it to the map
	var antitoner = L.tileLayer.gl({
		uniforms: {
			slrValue: Number(document.getElementById('add-slr').value)
		},
		fragmentShader: fragmentShader,
		opacity: 0.5,
		tileUrls: ['https://{s}.tiles.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=' + mapboxAccessToken]

	}).addTo(map);

	// LIQUEFACTION CODE //
	// VARIABLES TO BE USED:
	var slrValue;
	var data;
	var soilsLayer;
	var soildata;
	var value;
	var lSN;

	//define the style for the soils layers
	function soilStyle(feature) {
	return {
		fillColor: colorLSN,
		weight: 1,
		fillOpacity: 0.85,
		color: 'white',
		dashArray: '1',
		fillOpacity: 0.25
	}
	};

//	 load the GeoJSON data from the web
	 $.getJSON ("https://mychellew.github.io/mychellew-web/soils.geojson",
	 function (data){
		 // Store the data for later
		 var soildata = L.geoJson(data, {
			 style: soilStyle
		 }).addTo(map)
	 });

	//Get the parameters needed to determine the LSN to be mapped:
	//Extract the depth data from the soil layer

	function getDepth(feature){
	depth = feature.properties.depth
	};
	//Extract the Ev data (liquifaction susceptibility constant) from the soil data
	function getEv(feature){
	Ev = feature.properties.Ev
	};
	// Caluclate the LSN Value using the following equations and the following parameters
	//Note that Ev is divided by 100 as the data could not store decimals when exported from ArcMap
	// The Ev value should be in a fraction.
	function calculateLSN(data){
	onEachFeaure(Math.log(feature.properties.depth + slrValue) * (feature.properties_Ev/1000) * 1000)
	};

	// function onEachSoil(LSN){
	// // This is the class that will experience no or little land damage
	// if (LSN <= 10)
	// // Light to Moderate
	// if ((LSN > 10) && (LSN <= 20))
	// // Moderate to Medium Damage
	// if ((LSN > 20) && (LSN <= 30))
	// // Medium Damage
	// if ((LSN > 10) && (LSN <= 40))
	// // Severe Damage
	// if ((LSN > 10) && (LSN <= 50))
	// return '#FF0000'
	// };

	// Classify the data based on their LSN value
	 function colorLSN(LSN) {
		 // This is the class that will experience no or little land damage
	     return LSN < 10 										? '#800026' :
		 // Light to Moderate
	            ((LSN > 10) && (LSN <= 20)) ? '#BD0026' :
		 // Moderate to Medium Damage
	           	((LSN > 20) && (LSN <= 30)) ? '#E31A1C' :
	   // Medium Damage
	            ((LSN > 10) && (LSN <= 40)) ? '#FC4E2A' :
		 // Severe Damage
	            ((LSN > 10) && (LSN <= 50)) ? '#FD8D3C' :
	                       '#FFEDA0';
											 };
// var onlySLR = L.layerGroup([antitoner]);
// var liquefaction = L.layerGroup()
//
// L.control.layers(onlySLR, liquefaction).addTo(map);
//
// var toggleLayers = {
// 	"<span style=' color: gray'>Sea Level Rise Scenarios</span>": onlySLR,
// 	"Liquefaction Severity Number": liquefaction
// };

//Slider code was also modiefied from Iván Sánchez Ortega's sliders demo code:
// Repo is available from here: https://gitlab.com/IvanSanchez/Leaflet.TileLayer.GL/blob/master/demo/demo-sliders.html

	L.DomEvent.on(document.getElementById('add-slr'), 'change input', function(ev) {
		antitoner.setUniform('slrValue', ev.target.value);
		antitoner.reRender();
	});
	// Code for Legend
	var legend = L.control({position:'bottomright'}),

	addLegend = function (map) {

		var div = L.DomUtil.create('div', 'Liquefaction Severity Index'),
			grades = [10, 20, 30, 40, 50],
			labels = ["0-10", "10-20", "20-30","40-50","50+"];
			// loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + soilStyle(grades[i] + 1) + '"></i> ' +
            grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
    }

    return div;
	};

	legend.addTo(map);

	</script>
	</body>
	</html>
